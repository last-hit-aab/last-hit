{"version":3,"sources":["../lib/extension/wrappers/workspace.ts"],"names":[],"mappings":"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","file":"workspace.js","sourcesContent":["import { WorkspaceExtensions } from 'last-hit-types';\nimport {\n\tAbstractExtensionEntryPointWrapper,\n\tExtensionEventTypes,\n\tIExtensionEntryPointHelper\n} from '../../types';\n\nexport type EventHandler<E extends WorkspaceExtensions.WorkspaceEvent> = (\n\tevent: E,\n\thelpers: {\n\t\tbrowser: BrowserHelper;\n\t\ttest: TestHelper;\n\t}\n) => Promise<any>;\n\nclass BrowserHelper implements WorkspaceExtensions.IWorkspaceExtensionBrowserHelper {\n\tprivate helper: IExtensionEntryPointHelper;\n\n\tconstructor(helper: IExtensionEntryPointHelper) {\n\t\tthis.helper = helper;\n\t}\n\tgetHelper(): IExtensionEntryPointHelper {\n\t\treturn this.helper;\n\t}\n\tisInIDE(): boolean {\n\t\treturn this.getHelper().isInIDE();\n\t}\n\tgetElementAttrValue(\n\t\tcsspath: string,\n\t\tattrName: string,\n\t\tpageUuid?: string\n\t): Promise<string | null> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet timeout;\n\t\t\tconst onValue = (value: string | null) => {\n\t\t\t\tif (timeout) {\n\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t}\n\t\t\t\tresolve(value);\n\t\t\t};\n\t\t\tthis.helper.once(ExtensionEventTypes.BROWSER_OPERATION, onValue);\n\t\t\tthis.helper.sendBrowserOperation({\n\t\t\t\ttype: 'get-element-attr-value',\n\t\t\t\tcsspath,\n\t\t\t\tattrName,\n\t\t\t\tpageUuid\n\t\t\t});\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\tthis.helper.off(ExtensionEventTypes.BROWSER_OPERATION, onValue);\n\t\t\t\treject(new Error('Timeout'));\n\t\t\t}, 5000);\n\t\t});\n\t}\n\tgetElementPropValue(\n\t\tcsspath: string,\n\t\tpropName: string,\n\t\tpageUuid?: string\n\t): Promise<string | null> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tlet timeout;\n\t\t\tconst onValue = (value: string | null) => {\n\t\t\t\tif (timeout) {\n\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t}\n\t\t\t\tresolve(value);\n\t\t\t};\n\t\t\tthis.helper.once(ExtensionEventTypes.BROWSER_OPERATION, onValue);\n\t\t\tthis.helper.sendBrowserOperation({\n\t\t\t\ttype: 'get-element-prop-value',\n\t\t\t\tcsspath,\n\t\t\t\tpropName,\n\t\t\t\tpageUuid\n\t\t\t});\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\tthis.helper.off(ExtensionEventTypes.BROWSER_OPERATION, onValue);\n\t\t\t\treject(new Error('Timeout'));\n\t\t\t}, 5000);\n\t\t});\n\t}\n}\n\nclass TestNode {\n\tprivate title: string;\n\tprivate message?: string;\n\tprivate passed: boolean = false;\n\tprivate level: number = -1;\n\tprivate children: Array<TestNode> = [];\n\tprivate parent: TestNode | null = null;\n\tconstructor(title: string, passed: boolean, parent?: TestNode) {\n\t\tthis.title = title;\n\t\tthis.passed = passed;\n\t\tif (parent) {\n\t\t\tthis.parent = parent;\n\t\t\tthis.parent.children.push(this);\n\t\t\tthis.level = parent.level + 1;\n\t\t}\n\t}\n\tgetTitle(): string {\n\t\treturn this.title;\n\t}\n\tgetMessage(): string {\n\t\treturn this.message || '';\n\t}\n\tsetMessage(message: string) {\n\t\tthis.message = message;\n\t}\n\tgetLevel(): number {\n\t\treturn this.level;\n\t}\n\tisPassed(): boolean {\n\t\treturn this.passed;\n\t}\n\tsetPassed(passed: boolean): void {\n\t\tthis.passed = passed;\n\t}\n\tgetChildren(): Array<TestNode> {\n\t\treturn this.children;\n\t}\n\tgetParent(): TestNode | null {\n\t\treturn this.parent;\n\t}\n}\nclass TestHelper implements WorkspaceExtensions.IWorkspaceExtensionTestHelper {\n\tprivate helper: IExtensionEntryPointHelper;\n\tprivate rootTestNode = new TestNode('root', true);\n\tprivate currentTestNode: TestNode = this.rootTestNode;\n\n\tconstructor(helper: IExtensionEntryPointHelper) {\n\t\tthis.helper = helper;\n\t}\n\tprivate getHelper(): IExtensionEntryPointHelper {\n\t\treturn this.helper;\n\t}\n\tprivate async sendTestLog(node: TestNode, sendAnyway: boolean = false): Promise<void> {\n\t\tif (node.getLevel() === 0 || sendAnyway) {\n\t\t\tawait this.getHelper().sendTestLog(node.getTitle(), node.isPassed(), node.getLevel(), node.getMessage());\n\t\t\tawait Promise.all(\n\t\t\t\t(node.getChildren() || []).map(async child => await this.sendTestLog(child, true))\n\t\t\t);\n\t\t}\n\t}\n\tasync test(title: string, fn: () => void | Promise<void>): Promise<this> {\n\t\tconst node = new TestNode(title, false, this.currentTestNode);\n\t\ttry {\n\t\t\tthis.currentTestNode = node;\n\t\t\tawait fn.call(this);\n\t\t\tnode.setPassed(true);\n\t\t\tawait this.sendTestLog(node);\n\t\t\tthis.currentTestNode = node.getParent();\n\t\t} catch (e) {\n\t\t\tnode.setPassed(false);\n\t\t\tnode.setMessage(e.message);\n\t\t\tawait this.sendTestLog(node);\n\t\t\tthis.currentTestNode = node.getParent();\n\t\t\tthrow e;\n\t\t}\n\t\treturn this;\n\t}\n}\n\nexport class WorkspaceExtensionEntryPointWrapper extends AbstractExtensionEntryPointWrapper<\n\tWorkspaceExtensions.IWorkspaceExtensionEntryPoint\n> {\n\tprivate handlers: {\n\t\t[key in WorkspaceExtensions.WorkspaceEventTypes]: EventHandler<\n\t\t\tWorkspaceExtensions.WorkspaceEvent\n\t\t>;\n\t};\n\tprivate browserHelper: WorkspaceExtensions.IWorkspaceExtensionBrowserHelper;\n\tprivate testHelper: WorkspaceExtensions.IWorkspaceExtensionTestHelper;\n\n\tconstructor(\n\t\tentrypoint: WorkspaceExtensions.IWorkspaceExtensionEntryPoint,\n\t\thelper: IExtensionEntryPointHelper\n\t) {\n\t\tsuper(entrypoint, helper);\n\t\tthis.browserHelper = new BrowserHelper(helper);\n\t\tthis.testHelper = new TestHelper(helper);\n\n\t\tthis.handlers = {\n\t\t\t'env-prepare': entrypoint.handleEnvironmentPrepare,\n\t\t\t'story-prepare': entrypoint.handleStoryPrepare,\n\t\t\t'flow-should-start': entrypoint.handleFlowShouldStart,\n\t\t\t'flow-accomplished': entrypoint.handleFlowAccomplished,\n\t\t\t'step-should-start': entrypoint.handleStepShouldStart,\n\t\t\t'step-on-error': entrypoint.handleStepOnError,\n\t\t\t'step-accomplished': entrypoint.handleStepAccomplished,\n\t\t\t'reload-all-handlers': entrypoint.handleReloadAllHandlers,\n\t\t\t'reload-story-handler': entrypoint.handleReloadStoryHandler,\n\t\t\t'reload-flow-handler': entrypoint.handleReloadFlowHandler,\n\t\t\t'reload-step-handler': entrypoint.handleReloadStepHandler\n\t\t};\n\t}\n\tasync handle(event: WorkspaceExtensions.WorkspaceEvent): Promise<void> {\n\t\tconst handler: EventHandler<WorkspaceExtensions.WorkspaceEvent> = this.handlers[event.type];\n\t\tif (handler) {\n\t\t\ttry {\n\t\t\t\tconst result = await handler.call(this.getEntrypoint(), event, {\n\t\t\t\t\tbrowser: this.browserHelper,\n\t\t\t\t\ttest: this.testHelper\n\t\t\t\t});\n\t\t\t\treturn this.getHelper().sendMessage(result);\n\t\t\t} catch (e) {\n\t\t\t\treturn this.getHelper().sendError(e);\n\t\t\t}\n\t\t} else {\n\t\t\t// console.error(`Handler not found for event[${event.type}]`);\n\t\t\t// console.error(event);\n\t\t\treturn this.getHelper().sendIgnore();\n\t\t}\n\t}\n}\n"]}